<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Adaptive Art Gallery</title>
    <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
    <script src="https://unpkg.com/aframe-environment-component@1.3.3/dist/aframe-environment-component.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/c-frame/aframe-extras@7.0.0/dist/aframe-extras.min.js"></script>
    <script src="https://unpkg.com/super-hands@3.0.3/dist/super-hands.min.js"></script>
    
    <script>
      // detect what device we're running on
      const isVisionPro = /VisionOS|Apple Vision/i.test(navigator.userAgent);
      const isQuest = /Quest|Oculus/i.test(navigator.userAgent);
      const isMobile = /Mobile|Android|iPhone|iPad/i.test(navigator.userAgent);
      
      console.log('Device Detection:', {
        isVisionPro,
        isQuest,
        isMobile,
        userAgent: navigator.userAgent
      });

      AFRAME.registerComponent('smooth-locomotion', {
        init: function() {
          this.moveSpeed = 0.05; // 
        },
        
        tick: function() {
          const el = this.el;

          
          const tracked = el.components['tracked-controls'];
          if (!tracked || !tracked.controller) return;

          const gamepad = tracked.controller;
          if (!gamepad.axes || gamepad.axes.length < 2) return;

          const x = gamepad.axes[0]; // left/right
          const y = gamepad.axes[1]; // forward/back

          // deadzone
          if (Math.abs(x) < 0.15 && Math.abs(y) < 0.15) return;

          const rig = document.querySelector('#rig');     // 
          const camera = document.querySelector('#camera'); // use camera only for direction
          if (!rig || !camera) return;

          const rotY = camera.object3D.rotation.y;

          // direction based on camera facing
          const dx = ( Math.cos(rotY) * x + -Math.sin(rotY) * y ) * this.moveSpeed;
          const dz = ( -Math.sin(rotY) * x + -Math.cos(rotY) * y ) * this.moveSpeed;

          const newX = rig.object3D.position.x + dx;
          const newZ = rig.object3D.position.z + dz;

          // boundary check
          if (Math.abs(newX) < 5.5) rig.object3D.position.x = newX;
          if (Math.abs(newZ) < 5.5) rig.object3D.position.z = newZ;
        }
      });

      AFRAME.registerComponent('teleport-marker', {
        schema: {
          targetX: {default: 0},
          targetZ: {default: 0}
        },
        init: function() {
          const data = this.data;
          const rig = document.querySelector('#rig'); 

          // Hover effects
          this.el.addEventListener('mouseenter', () => {
            this.el.setAttribute('material', 'opacity', 0.8);
            this.el.setAttribute('scale', '1.2 1 1.2');
          });
          
          this.el.addEventListener('mouseleave', () => {
            this.el.setAttribute('material', 'opacity', 0.4);
            this.el.setAttribute('scale', '1 1 1');
          });
          
          // Click to teleport
          this.el.addEventListener('click', () => {
            if (!rig) return;
            console.log('Teleporting to: ' + data.targetX + ', ' + data.targetZ);

            // keep current Y
            const y = rig.object3D.position.y;
            rig.object3D.position.set(data.targetX, y, data.targetZ);
            
            // Visual feedback
            this.el.setAttribute('animation', {
              property: 'material.opacity',
              from: 1,
              to: 0.4,
              dur: 300
            });
          });
          
          // Gaze cursor interaction (Vision Pro)
          this.el.addEventListener('fusing', () => {
            this.el.setAttribute('material', 'opacity', 0.8);
            this.el.setAttribute('scale', '1.2 1 1.2');
          });
        }
      });

      // gaze cursor for vision pro - look at something to select it
      AFRAME.registerComponent('gaze-cursor', {
        schema: {
          fuseTime: {default: 1500}
        },
        init: function() {
          this.el.setAttribute('cursor', {
            fuse: true,
            fuseTimeout: this.data.fuseTime
          });
          this.el.setAttribute('raycaster', {
            objects: '.clickable, .grabbable'
          });
        }
      });

      // grab objects with either controllers or hands
      AFRAME.registerComponent('universal-grab', {
        init: function() {
          this.grabbed = false;
          this.grabber = null;
          
          // quest controllers use grip buttons
          this.el.addEventListener('gripdown', (evt) => {
            this.grab(evt.detail.hand);
          });
          
          this.el.addEventListener('gripup', (evt) => {
            this.release();
          });
          
          // desktop or vision pro can just click
          this.el.addEventListener('click', () => {
            if (!this.grabbed) {
              this.grab(document.querySelector('#camera'));
            } else {
              this.release();
            }
          });
          
          // pinch gesture for vision pro
          this.el.addEventListener('pinchstart', (evt) => {
            this.grab(evt.target);
          });
          
          this.el.addEventListener('pinchend', () => {
            this.release();
          });
        },
        
        grab: function(grabber) {
          this.grabbed = true;
          this.grabber = grabber;
          this.el.emit('grabbed');
          console.log('Object grabbed:', this.el.id);
        },
        
        release: function() {
          this.grabbed = false;
          this.el.emit('released');
          console.log('Object released:', this.el.id);
        }
      });

      // toggle light switch
      AFRAME.registerComponent('light-switch', {
        schema: {
          target: {type: 'selector'}
        },
        init: function() {
          const targetLight = this.data.target;
          let isOn = true;
          
          this.el.addEventListener('click', () => {
            isOn = !isOn;
            if (targetLight) {
              targetLight.setAttribute('light', 'intensity', isOn ? 8 : 0);
              this.el.setAttribute('color', isOn ? '#4CAF50' : '#f44336');
            }
          });
        }
      });

      // show/hide info panels
      AFRAME.registerComponent('info-panel', {
        init: function() {
          const panel = document.querySelector('#info-text');
          let visible = false;
          
          this.el.addEventListener('click', () => {
            visible = !visible;
            panel.setAttribute('visible', visible);
            this.el.setAttribute('color', visible ? '#2196F3' : '#666');
          });
        }
      });

      // background audio
      AFRAME.registerComponent('ambient-audio', {
        init: function() {
          const context = new (window.AudioContext || window.webkitAudioContext)();
          const oscillator = context.createOscillator();
          const gainNode = context.createGain();
          
          oscillator.connect(gainNode);
          gainNode.connect(context.destination);
          
          oscillator.frequency.value = 110;
          oscillator.type = 'sine';
          gainNode.gain.value = 0.02;
          
          this.el.addEventListener('click', () => {
            if (context.state === 'suspended') {
              context.resume();
              oscillator.start();
              this.el.setAttribute('material', 'emissive', '#00ff00');
            }
          });
        }
      });

      // screenshot mode toggle
      document.addEventListener('keydown', (evt) => {
        if (evt.key === 'h' || evt.key === 'H') {
          const gazeCursor = document.querySelector('#gaze-cursor');
          const leftHand = document.querySelector('#leftHand');
          const rightHand = document.querySelector('#rightHand');
          const teleportMarkers = document.querySelectorAll('[teleport-marker]');
          
          if (gazeCursor) {
            const isVisible = gazeCursor.getAttribute('visible');
            gazeCursor.setAttribute('visible', !isVisible);
          }
          
          if (leftHand) {
            const isVisible = leftHand.getAttribute('visible');
            leftHand.setAttribute('visible', !isVisible);
          }
          
          if (rightHand) {
            const isVisible = rightHand.getAttribute('visible');
            rightHand.setAttribute('visible', !isVisible);
          }
          
          teleportMarkers.forEach(marker => {
            const isVisible = marker.getAttribute('visible');
            marker.setAttribute('visible', !isVisible);
          });
          
          console.log('Screenshot mode toggled');
        }
      });

      // load the 3d models
      document.addEventListener('DOMContentLoaded', () => {
        console.log('Controls Mode:', isVisionPro ? 'Vision Pro (Hands/Gaze)' : isQuest ? 'Quest 3 (Controllers)' : 'Desktop (Mouse)');

        for (let i = 1; i <= 4; i++) {
          const benchModel = document.querySelector(`#bench-model-${i}`);
          if (benchModel) {
            benchModel.addEventListener('model-loaded', () => {
              console.log('Bench ' + i + ' loaded');
            });
          }
        }
        
        const magazines = document.querySelector('#magazines');
        if (magazines) {
          magazines.addEventListener('model-loaded', () => {
            console.log('Magazines loaded');
          });
        }

  
        if (!isQuest) {
          const lh = document.querySelector('#leftHand');
          const rh = document.querySelector('#rightHand');
          if (lh) lh.setAttribute('visible', 'false');
          if (rh) rh.setAttribute('visible', 'false');
        }
      });
    </script>
  </head>

  <body>
    <a-scene 
      background="color: #ffffff" 
      renderer="colorManagement: true; antialias: true; physicallyCorrectLights: true; exposure: 1.1; foveationLevel: 1"
      shadow="type: pcfsoft">

      <a-assets>
        <img id="art-main" src="https://i0.wp.com/blog.artsper.com/wp-content/uploads/2024/09/Vincent_van_Gogh_-_Self-Portrait_-_Google_Art_Project-4.jpg?fit=520%2C632&ssl=1">
        <img id="art-side-1" src="https://cdn.topofart.com/images/artists/Claude_Oscar_Monet/paintings-wm/monet018.jpg">
        <img id="art-side-2" src="https://cdn.topofart.com/images/artists/John_William_Waterhouse/paintings-wm/waterhouse001.jpg">
        <img id="marble" src="https://images.unsplash.com/photo-1599026466981-22d7183e8568?auto=format&fit=crop&w=500&q=60">
      </a-assets>

      <!-- Lighting -->
      <a-entity light="type: hemisphere; color: #ffffff; groundColor: #bbbbbb; intensity: 1.2"></a-entity>
      <a-entity light="type: directional; color: #fffaf0; intensity: 1.5; castShadow: true; shadowMapSize: 2048" position="-4 5 4"></a-entity>

      <!-- Ceiling lights -->
      <a-entity position="0 3.9 0">
        <a-cylinder radius="0.12" height="0.02" color="#fff" material="emissive: #fff; emissiveIntensity: 2"></a-cylinder>
        <a-entity light="type: spot; intensity: 4; angle: 60; penumbra: 0.5" rotation="-90 0 0"></a-entity>
      </a-entity>
      
      <a-entity position="0 3.9 -3">
        <a-cylinder radius="0.1" height="0.02" color="#fff" material="emissive: #fff"></a-cylinder>
        <a-entity light="type: spot; intensity: 6; angle: 45; penumbra: 0.2; castShadow: true" rotation="-45 0 0"></a-entity>
      </a-entity>
      
      <!-- Interactive spotlight -->
      <a-entity position="-3.5 3.9 -3.5">
        <a-cylinder radius="0.1" height="0.02" color="#fff" material="emissive: #fff"></a-cylinder>
        <a-entity id="sculpture-light" light="type: spot; intensity: 8; angle: 30; penumbra: 0.2; castShadow: true" rotation="-45 -45 0"></a-entity>
      </a-entity>

      <!-- Room structure -->
      <a-entity id="room">
        <a-plane position="0 0 0" rotation="-90 0 0" width="12" height="12" color="#e0d0c0" material="roughness: 0.6; metalness: 0.1" shadow="receive: true"></a-plane>
        <a-plane position="0 4 0" rotation="90 0 0" width="12" height="12" color="#fff"></a-plane>
        <a-plane position="0 2 -6" width="12" height="4" color="#f5f5f5" shadow="receive: true"></a-plane>
        <a-plane position="0 2 6" rotation="0 180 0" width="12" height="4" color="#333" shadow="receive: true"></a-plane>
        <a-plane position="-6 2 0" rotation="0 90 0" width="12" height="4" color="#f5f5f5" shadow="receive: true"></a-plane>
        <a-plane position="6 2 0" rotation="0 -90 0" width="12" height="4" color="#f5f5f5" shadow="receive: true"></a-plane>
      </a-entity>

      <!-- Interactive sculpture -->
      <a-entity id="sculpture" position="-4 0 -4" rotation="0 45 0">
        <a-box 
            width="0.8" height="1.2" depth="0.8" 
            src="#marble"
            color="#fff" 
            shadow="cast: true; receive: true">
        </a-box>

        <a-torus-knot 
            position="0 1.2 0" 
            radius="0.4" 
            radius-tubular="0.06" 
            p="3" q="7" 
            color="#ffcc00"
            material="metalness: 1.0; roughness: 0.15"
            shadow="cast: true"
            animation="property: rotation; to: 0 360 0; loop: true; dur: 25000; easing: linear"
            class="clickable grabbable"
            universal-grab>
        </a-torus-knot>
        
        <a-box 
            position="0 1.2 0" 
            width="0.9" height="1.0" depth="0.9" 
            color="#aaddff" 
            material="opacity: 0.2; transparent: true; roughness: 0; metalness: 0.9"
            shadow="cast: false">
        </a-box>
      </a-entity>

      <!-- Main artwork with info button -->
      <a-entity id="main-art" position="0 2 -5.9">
         <a-box width="3.2" height="2.2" depth="0.1" color="#111"></a-box>
         <a-plane position="0 0 0.06" width="3" height="2" src="#art-main" material="roughness: 0.5"></a-plane>
         
         <a-box 
            position="1.8 -1.3 0.1" 
            width="0.3" height="0.3" depth="0.05" 
            color="#666"
            class="clickable"
            info-panel>
            <a-text value="i" align="center" position="0 0 0.03" color="#fff" width="2"></a-text>
         </a-box>
         
         <a-plane 
            id="info-text"
            position="0 -1.5 0.15" 
            width="2.5" height="0.8" 
            color="#000" 
            opacity="0.85"
            visible="false">
            <a-text 
               value="Abstract Composition\nContemporary Digital Art\n2024" 
               align="center" 
               position="0 0 0.01" 
               color="#fff" 
               width="2.2"
               wrap-count="30">
            </a-text>
         </a-plane>
      </a-entity>

      <!-- Side artworks -->
      <a-entity position="-5.9 2 0" rotation="0 90 0">
         <a-box width="3.2" height="1.6" depth="0.1" color="#111"></a-box>
         <a-plane position="0 0 0.06" width="3" height="1.4" src="#art-side-1" material="roughness: 0.5"></a-plane>
         <a-box position="-1 1 0.1" width="0.2" height="0.05" depth="0.1" color="#333">
            <a-entity light="type: point; intensity: 0.5; color: #ffaa00; distance: 2" position="0 -0.2 0.2"></a-entity>
         </a-box>
         <a-box position="1 1 0.1" width="0.2" height="0.05" depth="0.1" color="#333">
             <a-entity light="type: point; intensity: 0.5; color: #ffaa00; distance: 2" position="0 -0.2 0.2"></a-entity>
         </a-box>
      </a-entity>

      <a-entity position="5.9 2 0" rotation="0 -90 0">
         <a-box width="1.6" height="2.2" depth="0.1" color="#111"></a-box>
         <a-plane position="0 0 0.06" width="1.4" height="2" src="#art-side-2" material="roughness: 0.5"></a-plane>
      </a-entity>

      <!-- 4 Modern Benches -->
      <a-entity position="0 0 0.5">
         <a-entity 
            id="bench-model-1"
            position="0 0 0" 
            rotation="0 0 0"
            scale="1 1 1"
            gltf-model="bench-embedded.gltf"
            shadow="cast: true; receive: true">
         </a-entity>
      </a-entity>
      
      <a-entity position="-3.5 0 -1">
         <a-entity 
            id="bench-model-2"
            position="0 0 0" 
            rotation="0 90 0"
            scale="1 1 1"
            gltf-model="bench-embedded.gltf"
            shadow="cast: true; receive: true">
         </a-entity>
      </a-entity>
      
      <a-entity position="3.5 0 -1">
         <a-entity 
            id="bench-model-3"
            position="0 0 0" 
            rotation="0 -90 0"
            scale="1 1 1"
            gltf-model="bench-embedded.gltf"
            shadow="cast: true; receive: true">
         </a-entity>
      </a-entity>
      
      <a-entity position="0 0 -3.5">
         <a-entity 
            id="bench-model-4"
            position="0 0 0" 
            rotation="0 180 0"
            scale="1 1 1"
            gltf-model="bench-embedded.gltf"
            shadow="cast: true; receive: true">
         </a-entity>
      </a-entity>

      <!-- Coffee table with interactive magazines -->
      <a-entity position="0 0 3">
         <a-cylinder 
            position="0 0.2 0" 
            radius="0.25" height="0.03" 
            color="#1a1a1a" 
            material="roughness: 0.1; metalness: 0.9" 
            shadow="cast: true; receive: true">
         </a-cylinder>
         <a-cylinder 
            position="0 0.1 0" 
            radius="0.04" height="0.2" 
            color="#0a0a0a"
            material="roughness: 0.3; metalness: 0.7">
         </a-cylinder>
         
         <a-entity 
            id="magazines"
            position="0 0.23 0" 
            rotation="0 25 0"
            scale="0.5 0.5 0.5"
            gltf-model="magazines-embedded.gltf"
            shadow="cast: true"
            class="clickable grabbable"
            universal-grab>
         </a-entity>
      </a-entity>

      <!-- Teleport Markers (unchanged) -->
      <a-cylinder position="0 0.01 4" radius="0.4" height="0.02"
        color="#2196F3"
        material="opacity: 0.4; transparent: true; emissive: #2196F3; emissiveIntensity: 0.5"
        class="clickable"
        teleport-marker="targetX: 0; targetZ: 4"
        animation="property: rotation; to: 0 360 0; loop: true; dur: 8000; easing: linear">
        <a-ring position="0 0.01 0" radius-inner="0.35" radius-outer="0.4" color="#fff" opacity="0.6"></a-ring>
      </a-cylinder>

      <a-cylinder position="0 0.01 1.5" radius="0.4" height="0.02"
        color="#2196F3"
        material="opacity: 0.4; transparent: true; emissive: #2196F3; emissiveIntensity: 0.5"
        class="clickable"
        teleport-marker="targetX: 0; targetZ: 1.5"
        animation="property: rotation; to: 0 360 0; loop: true; dur: 8000; easing: linear">
        <a-ring position="0 0.01 0" radius-inner="0.35" radius-outer="0.4" color="#fff" opacity="0.6"></a-ring>
      </a-cylinder>

      <a-cylinder position="-4.5 0.01 0" radius="0.4" height="0.02"
        color="#2196F3"
        material="opacity: 0.4; transparent: true; emissive: #2196F3; emissiveIntensity: 0.5"
        class="clickable"
        teleport-marker="targetX: -4.5; targetZ: 0"
        animation="property: rotation; to: 0 360 0; loop: true; dur: 8000; easing: linear">
        <a-ring position="0 0.01 0" radius-inner="0.35" radius-outer="0.4" color="#fff" opacity="0.6"></a-ring>
      </a-cylinder>

      <a-cylinder position="4.5 0.01 0" radius="0.4" height="0.02"
        color="#2196F3"
        material="opacity: 0.4; transparent: true; emissive: #2196F3; emissiveIntensity: 0.5"
        class="clickable"
        teleport-marker="targetX: 4.5; targetZ: 0"
        animation="property: rotation; to: 0 360 0; loop: true; dur: 8000; easing: linear">
        <a-ring position="0 0.01 0" radius-inner="0.35" radius-outer="0.4" color="#fff" opacity="0.6"></a-ring>
      </a-cylinder>

      <a-cylinder position="-3 0.01 -3" radius="0.4" height="0.02"
        color="#2196F3"
        material="opacity: 0.4; transparent: true; emissive: #2196F3; emissiveIntensity: 0.5"
        class="clickable"
        teleport-marker="targetX: -3; targetZ: -3"
        animation="property: rotation; to: 0 360 0; loop: true; dur: 8000; easing: linear">
        <a-ring position="0 0.01 0" radius-inner="0.35" radius-outer="0.4" color="#fff" opacity="0.6"></a-ring>
      </a-cylinder>

      <a-cylinder position="0 0.01 -4.5" radius="0.4" height="0.02"
        color="#2196F3"
        material="opacity: 0.4; transparent: true; emissive: #2196F3; emissiveIntensity: 0.5"
        class="clickable"
        teleport-marker="targetX: 0; targetZ: -4.5"
        animation="property: rotation; to: 0 360 0; loop: true; dur: 8000; easing: linear">
        <a-ring position="0 0.01 0" radius-inner="0.35" radius-outer="0.4" color="#fff" opacity="0.6"></a-ring>
      </a-cylinder>

      <!-- Light control panel -->
      <a-entity position="5 1.5 -5" rotation="0 45 0">
        <a-box width="0.4" height="0.6" depth="0.05" color="#ddd"></a-box>
        <a-box 
           position="0 0.15 0.03" 
           width="0.15" height="0.15" depth="0.02" 
           color="#4CAF50"
           class="clickable"
           light-switch="target: #sculpture-light">
           <a-text value="LIGHT" align="center" position="0 0.12 0.02" color="#000" width="1"></a-text>
        </a-box>
      </a-entity>

      <!-- Camera Rig -->
      <a-entity id="rig" position="0 0 5">
        <a-entity 
           id="camera" 
           camera 
           position="0 1.6 0" 
           look-controls="pointerLockEnabled: false">
           
           <!-- Vision Pro: Enhanced gaze cursor -->
           <a-entity 
              id="gaze-cursor"
              cursor="fuse: true; fuseTimeout: 1500"
              position="0 0 -1.5"
              raycaster="objects: .clickable, .grabbable; far: 15"
              visible="true">
              <a-ring radius-inner="0.015" radius-outer="0.025"
                material="color: #2196F3; shader: flat; opacity: 0.8"></a-ring>
              <a-circle radius="0.008"
                material="color: white; shader: flat; opacity: 0.9"></a-circle>
           </a-entity>
        </a-entity>
        
        <a-entity 
           id="leftHand"
           oculus-touch-controls="hand: left; model: true"
           laser-controls="hand: left"
           raycaster="objects: .clickable, .grabbable; far: 10"
           cursor="rayOrigin: entity" 
           smooth-locomotion>
        </a-entity>
        
        <a-entity 
           id="rightHand"
           oculus-touch-controls="hand: right; model: true"
           laser-controls="hand: right"
           raycaster="objects: .clickable, .grabbable; far: 10"
           cursor="rayOrigin: entity"> 
        </a-entity>
        
        <!-- Vision Pro placeholder -->
        <a-entity id="vision-pro-hands" visible="false"></a-entity>
      </a-entity>

    </a-scene>
  </body>
</html>
